<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" , initial-scale="1">
    <title>프로젝트</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <style type="text/css">
        .jumbotron {
            background-image: url('images/bonobono.jpg');
            background-size: cover;
            text-shadow: black 0.2em 0.2em 0.2em;
            color: white;
        }

        .dropdown:hover > .dropdown-menu {
            display: block;
        }

        .icon-btn {
            border: 0;
            outline: 0;
            background: transparent;
        }

        .noresize {
            resize: none; /* 사용자 임의 변경 불가 */
        }

        .main-area {
            border: 1px solid #ccc;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#bs-example-navber-collapse-1"
                    aria-expanded="false">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="./index.html">모여모여게시판</a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a href="">포트폴리오 <span class="sr-only"></span></a></li>
                <li class="active"><a href="">게시판 <span class="sr-only"></span></a></li>
            </ul>

            <ul class="nav navbar-nav pull-right">
                <li class="active"><a href="./mypage.html">마이페이지<span class="sr-only"></span></a></li>
            </ul>

        </div>
    </div>
</nav>
<div class="container">
    <div class="container">
        <div class="jumbotron">
            <h1 class="text-center">모모게시판</h1>
            <p class="text-center"> 프로젝트의 거대한 도우미</p>
        </div>
    </div>
    <div class="container main-area">
        <div class="container">
            <div class="col-sm-3">
                <input type="hidden" name="project" id="projectNo">
                <div class="container input-group input-group-lg">
                    <div class=" col-sm-8">
                        <h1 id="title">
                            게임만들기
                        </h1>

                    </div>
                </div>

                <div class="container input-group input-group-lg">
                    <h4><b>주최자</b></h4>
                    <div class="col-sm-6" id="organizer">
                        jimen
                    </div>
                </div>
                <hr style="border: solid 1px ;">
                <div class="container input-group input-group-lg" id="employees">
                    <h4><b>전체 인원 / 현재 인원</b></h4>
                    <div class="col-sm-1" id="number">
                        6 / 2
                    </div>
                    <button id="applicantBtn">지원자 확인</button>
                </div>
                <hr style="border: solid 1px ;">

                <div class="container input-group input-group-lg">
                    <h4><b>진행 상황</b></h4>
                    <div class="col-sm-6" id="process">
                        모집 중
                    </div>
                </div>
                <hr style="border: solid 1px ;">

                <div class="container input-group">
                    <h4><b>기간</b></h4>
                    <div class="col-sm-3" id="date">
                        2020-4-27 ~ 2020-5-27
                    </div>
                </div>
                <hr style="border: solid 1px ;">

                <div class="container input-group input-group-lg">
                    <h4><b>세부내용</b></h4>
                    <div class="col-sm-6">
                        <textarea class="form-control col-sm-5 noresize" id="content" rows="10" cols="30"
                                  disabled></textarea>
                    </div>
                </div>
            </div>
            <div class="col-sm-offset-5 col-sm-2">
                <div class="row">
                    <div class="">
                        <h3>세부인원</h3>
                        <ul class="list-group" id="members">
                            <li class="list-group-item">&nbsp; 고재우 <b class="pull-right">디자인&nbsp;</b></li>
                            <li class="list-group-item">&nbsp; 허지식 <b class="pull-right">개발진&nbsp;</b></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="">
                <div class="text-center">
                    <!-- 모달을 열기 위한 버튼 -->
                    <button type="button" class="btn btn-primary btn-lg" id="openModalBtn">
                        신청하기
                    </button>
                    <!-- 모달 영역 -->
                    <div id="modalBox" class="modal fade" id="myModal" tabindex="-1" role="dialog"
                         aria-labelledby="myModalLabel">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                            aria-hidden="true">×</span></button>
                                    <h4 class="modal-title" id="myModalLabel">자기소개</h4>
                                </div>
                                <div class="modal-body">
                                    <textarea name="content" class="form-control col-sm-5 noresize" rows="10"
                                              cols="30"></textarea>
                                </div>
                                <br>
                                <div class="modal-footer">
                                    <div class="pull-left">
                                        <select name="field.no" id="fields"></select>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="applyBtn">신청</button>
                                    <button type="button" class="btn btn-default" id="closeModalBtn">취소</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="js/myLibrary.js"></script>
<script>
	const members = $('#members');
	const openModalBtn = $('#openModalBtn');
	const closeModalBtn = $('#closeModalBtn');
	const fields = $('#fields');
	const applyBtn = $('#applyBtn');
	const applicantBtn = $('#applicantBtn');
	const params = getParameters();
	let username = '';

	$.ajax({
		type: 'get',
		url: './api/user/',
		dataType: 'json',
		async: false,
		success: (data) => {
			// 받은 유저 정보를 출력
			username = data.nickname;
		},
		error: () => {
			alert('세션이 만료되었습니다.');
			window.location = './signIn.html';
		}
	});

	$.ajax({
		type: 'get',
		url: `./api/project/${ params.no }`,
		dataType: 'json',
		async: false,
		success: (data) => {
			const presentNumbers = {};
			const allNumbers = {};
			const processList = ['모집중', '진행중', '완료'];
			let presentNumber = 0, allNumber = 0;

			$('#projectNo').val(data.project.no);

			$('#title').val(data.project.title);
			$('#organizer').val(data.project.organizer.nickname);
			if (username == data.project.organizer.nickname) {
				applicantBtn.on('click', (e) => {
					e.preventDefault();
					window.location = `./volunteerCheck.html?no=${ data.project.no }`;
				});

				applyBtn.val('수정하기');
				applyBtn.on('click', (e) => {
					e.preventDefault();
					window.location = `./projectFix.html?no=${ data.project.no }`;
				});
			}
			else {
				applicantBtn.remove();
			}

			members.empty();
			for (const member of data.members) { // 현재 인원 현황
				const field = member.field.field;
				members.append(`<li class="list-group-item">&nbsp; ${ member.user.nickname } <b class="pull-right">${ field }&nbsp;</b></li>`);
				presentNumbers[field] = presentNumbers.hasOwnProperty(field) ? presentNumbers[field] + 1 : 1;
				presentNumber++;
				if (username == member.user.nickname) {
					$('#title').append('<button type="button" class="btn btn-primary btn-lg" id="chatBtn">채팅방</button>');
					$('#chatBtn').on('click', (e) => {
						e.preventDefault();
						sessionStorage.setItem('project.id', data.project.no);
						window.location = `./chatRoom.html`;
                    })
                }
			}

			for (const applyField of data.applyFields) { // 전체 인원 현황
				const field = applyField.field;

				allNumbers[field] = applyField.number;
				allNumber += applyField.number;

				if (!presentNumbers.hasOwnProperty(applyField.field)) {
					presentNumbers[applyField.field] = 0;
				}

				if (allNumbers[field] - presentNumbers[field] != 0) {
					fields.append(`<option value="${ applyField.no }" >${ field }</option>`);
				}
			}

			let item = `<div class="dropdown">${ presentNumber } / ${ allNumber }` +
				'<span class="pull-right">▽</span>' +
				'<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">';

			for (const field in allNumbers) {
				item += `${ field } ${ presentNumbers[field] } / ${ allNumbers[field] }<br>`;
			}

			item = item.substr(0, item.length - 4);

			item += '</div></div>';

			$('#number').html(item);
			$('#process').val(processList[data.project.process]);
			$('#date').val(`${ data.project.start } ~ ${ data.project.end }`);
			$('#content').val(data.project.content);
		},
		error: () => {
			alert('세션이 만료되었습니다.');
			window.location = './signIn.html';
		}
	});

	if (params.check) {
		openModalBtn.text('확인');
		openModalBtn.on('click', (e) => {
			e.preventDefault();
			window.location = './mypage.html';
		});
	}
	else {
		// 모달 버튼에 이벤트를 건다.
		openModalBtn.on('click', (e) => {
			e.preventDefault();
			$('#modalBox').modal('show');
		});

		// 모달 안의 취소 버튼에 이벤트를 건다.
		closeModalBtn.on('click', (e) => {
			e.preventDefault();
			$('#modalBox').modal('hide');
		});

		applyBtn.on('click', (e) => {
			e.preventDefault();
			$.ajax({
				type: 'post',
				url: `./api/applicant/insert`,
				dataType: 'json',
				data: $('form').serialize(),
				async: false,
				success: (data) => {
					alert('신청이 완료되었습니다.');
					window.location = './index.html';
				},
				error: () => {
					alert('세션이 만료되었습니다.');
					window.location = './signIn.html';
				}
			});
		});
	}
</script>
</body>
</html>
