<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <title>회원가입</title>
    <link rel="stylesheet" href="css/bootstrap.css">
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#bs-example-navber-collapse-1"
                    aria-expanded="false">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="">모여모여게시판</a>
        </div>
    </div>
</nav>
<div class="container">
    <form class="navbar-form navbar-left">
        <div class="container input-group input-group-lg">
            <h4><b>이메일</b></h4>
            <div class="col-lg-6">
                <input type="email" class="form-control" placeholder="@example.com" id="emailTxt">
                <span class="input-group-btn">
                    <button type="button" class="btn btn-primary" id="emailBtn">중복확인</button>
                </span>
            </div><!-- /.col-sm-6 -->
        </div>
        <div class="container input-group input-group-lg">
            <div class="col-sm-6">
                <input type="text" class="form-control" id="codeTxt" placeholder="인증코드">
                <span class="input-group-btn">
                    <button type="button" class="btn btn-primary" id="codeCheckBtn">확인</button>
                </span>
                <input type="hidden" id="code">
            </div><!-- /.col-sm-6 -->
        </div>
        <div class="container input-group input-group-lg">
            <h4><b>비밀번호</b></h4>
            <div class="col-sm-3">
                <input type="password" class="form-control" placeholder="비밀번호" id="pwdTxt">
                <input type="password" class="form-control" placeholder="비밀번호 확인" id="pwdCheckTxt">
            </div><!-- /.col-sm-6 -->
        </div>
        <div class="container input-group input-group-lg">
            <h4><b>닉네임</b></h4>
            <div class="col-sm-6">
                <input type="text" class="form-control" placeholder="홍길동" id="nicknameTxt">
                <span class="input-group-btn">
                    <button type="button" class="btn btn-primary" id="nicknameCheckBtn">중복확인</button>
                </span>
                <input type="hidden" id="nickname">
            </div><!-- /.col-sm-6 -->
        </div>
        <div class="container input-group input-group-lg">
            <h4><b>전화번호</b></h4>
            <div class="col-sm-6">
                <input type="tel" class="form-control" id="phoneTxt" placeholder="010-xxxx-xxxx">
            </div><!-- /.col-sm-6 -->
        </div>
        <div class="container input-group input-group-lg">
            <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-primary btn-lg" id="signUpBtn">회원가입</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/myLibrary.js"></script>
<script>
	const emailTxt = $('#emailTxt');
	const emailBtn = $('#emailBtn');
	const pwdTxt = $('#pwdTxt');
	const pwdCheckTxt = $('#pwdCheckTxt');
	const codeTxt = $('#codeTxt');
	const codeCheckBtn = $('#codeCheckBtn');
	const code = $('#code');
	const nicknameTxt = $('#nicknameTxt');
	const nicknameCheckBtn = $('#nicknameCheckBtn');
	const nickname = $('#nickname');
	const phoneTxt = $('#phoneTxt');
	const signUpBtn = $('#signUpBtn');

	async function init() {
		codeTxt.attr('disabled', true);
		codeCheckBtn.attr('disabled', true);

		emailBtn.on('click', (e) => {
			e.preventDefault();

			if (checkEmailValidation()) {
				sendAuthenticationCode();
			}
		});

		codeCheckBtn.on('click', (e) => {
			e.preventDefault();

			if (checkCodeValidation()) {
				confirmCode();
			}
		});

		nicknameCheckBtn.on('click', (e) => {
			e.preventDefault();

			if (checkNickname()) {
				confirmNickname();
			}
		});

		signUpBtn.on('click', (e) => {
			e.preventDefault();

			if (checkSignUpValidation()) {
				signUp();
			}
		});
	}

	function checkEmailValidation() {
		if (emailTxt.val() == '') {
			alert('이메일을 입력해주세요.');
			emailTxt.focus();
		}
		else {
			const emailExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
			if (emailExp.test(emailTxt.val())) {
				return true;
			}
			else {
				alert('올바르지 않은 이메일 형식입니다.\n다시 입력하여 주시기 바랍니다.');
				emailTxt.val('');
				emailTxt.focus();
			}
		}

		return false;
	}

	function checkCodeValidation() {
		if (codeTxt.val() == '') {
			alert('인증 코드를 입력해주세요.');
			codeTxt.focus();
		}
		else {
			return true;
		}

		return false;
	}

	function checkNickname() {
		if (nicknameTxt.val() == '') {
			alert('닉네임을 입력해주세요.');
			nicknameTxt.focus();
		}
		else {
			return true;
		}

		return false;
	}

	function checkSignUpValidation() {
		if (emailTxt.val() == '') {
			alert('이메일을 입력해주세요.');
		}
		else if (code.val() == '') {
			alert('이메일 인증을 완료해주세요.');
		}
		else if (pwdTxt.val() == '') {
			alert('비밀번호를 입력해주세요.');
		}
		else if (pwdTxt.val() != pwdCheckTxt.val()) {
			alert('비밀번호와 비밀번호 확인이 다릅니다.');
		}
		else if (nickname.val() == '') {
			alert('닉네임을 검증해주세요.');
		}
		else {
			return true;
		}

		return false;
	}

	async function sendAuthenticationCode() {
		let errorCode = 0;
		try {
			const result = await $.get(getAjaxObject('./api/user/check/email', { email: emailTxt.val() }));
			errorCode++;
			if (result) {
				await $.get(getAjaxObject('./api/user/confirm/email', { email: emailTxt.val() }));

				alert('인증코드가 전송되었습니다.');

				emailTxt.attr('disabled', true);
				emailBtn.attr('disabled', true);
				codeTxt.attr('disabled', false);
				codeCheckBtn.attr('disabled', false);

				codeTxt.focus();
			}
			else {
				alert('이미 존재하는 이메일입니다.');
				emailTxt.val('');
				emailTxt.focus();
			}
		}
		catch (e) {
			switch (errorCode) {
				case 0:
					console.log('spring boot exception');
				case 1:
					alert('인증코드를 전송하지 못하였습니다.');
			}
		}
	}

	async function confirmCode() {
		try {
			const result = await $.get(getAjaxObject('./api/user/confirm/email/check', { code: codeTxt.val() }));
			if (result) {
				alert('메일인증이 완료되었습니다.');
				codeTxt.attr('disabled', true);
				codeCheckBtn.attr('disabled', true);
				code.val(codeTxt.val());
			}
			else {
				alert('인증코드가 올바르지 않습니다.');
				codeTxt.val('');
				codeTxt.focus();
			}
		}
		catch (e) {
			alert('이메일 중복 체크를 해주세요.');
			emailTxt.focus();
		}
	}

	async function confirmNickname() {
		try {
			const result = await $.get(getAjaxObject('./api/user/check/nickname'));
			if (result) {
				alert('사용 가능한 닉네임입니다.');
				nicknameTxt.attr('disabled', true);
				nicknameCheckBtn.attr('disabled', true);
				nickname.val(nicknameTxt.val());
				phoneTxt.focus();
			}
			else {
				alert('이미 존재하는 닉네임입니다.');
				nicknameTxt.val('');
				nicknameTxt.focus();
			}
		}
		catch (e) {
			console.log('spring boot exception');
		}
	}

	async function signUp() {
		try {
			const result = await $.post(getAjaxObject('./api/user/insert', {
				email: emailTxt.val(), password: pwdTxt.val(),
				nickname: nicknameTxt.val(), phone: phoneTxt.val()
			}));
			if (result) {
				alert('회원가입 성공하였습니다.');
				window.location = './signIn.html';
			}
			else {
				alert('이메일 검증을 완료해주세요.');
			}
		}
		catch (e) {
			alert('회원가입 실패하였습니다.');
		}
	}

	init();
</script>
</body>
</html>