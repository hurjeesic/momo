<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width" , initial-scale="1">
    <title>포트폴리오</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/myStyle.css">
    <style type="text/css">
        .jumbotron {
            background-image: url('images/bonobono.jpg');
            background-size: cover;
            text-shadow: black 0.2em 0.2em 0.2em;
            color: white;
        }

        .dropdown:hover > .dropdown-menu {
            display: block;
        }

        .main-area {
            border: 1px solid #ccc;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#bs-example-navber-collapse-1"
                    aria-expanded="false">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand">모여모여게시판</a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active" id="portfolioBtn"><a>포트폴리오<span class="sr-only"></span></a></li>
                <li class="active" id="boardBtn"><a>게시판<span class="sr-only"></span></a></li>
            </ul>
            <ul class="nav navbar-nav pull-right">
                <li class="active" id="logoutBtn"><a>로그아웃<span class="sr-only"></span></a></li>
                <li class="active" id="myPageBtn"><a>마이페이지<span class="sr-only"></span></a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <div class="container">
        <div class="jumbotron">
            <h1 class="text-center">포트폴리오</h1>
            <p class="text-center"> 프로젝트의 거대한 도우미</p>
        </div>
    </div>
    <div class="container main-area">
        <h3>완료한 프로젝트</h3>
        <div class="row">
            <div class="col-md-12">
                <div class="">
                    <div class="table">
                        <table class="table table-hover results">
                            <thead>
                            <tr>
                                <th class="col-md-1">번호</th>
                                <th class="col-md-4">제목</th>
                                <th class="col-sm-2">종료일시</th>
                                <th class="col-md-2">주최자</th>
                                <th class="col-md-2">인원</th>
                                <th class="col-md-2">파일</th>
                            </tr>
                            </thead>
                            <tbody id="completedProjectList">
                            <tr>
                                <td>1</td>
                                <td class="dropdown"><a href="">게임만들기</a>
                                    <a class="dropdown-toggle pull-right"
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                        게임만들기에 대한 간단한 설명입니다 이건 게임을 만드는 프로젝트에요
                                    </div>
                                </td>
                                <td>2020/04/27</td>
                                <td>고재우</td>
                                <td class="dropdown">4/5
                                    <a class=" pull-right">
                                        다운로드
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                        개발자 3 / 4
                                        <br>
                                        기획자 1 / 1
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    &nbsp;
    <div class="container">
        <div class="row">
            <div class="main-area col-md-5">
                <h3>자격증</h3>
                <button type="button" class="pull-right" id="certificateDeleteBtn">삭제</button>
                <div class="">
                    <div class="table">
                        <form id="certificateDeleteForm">
                            <table class="table table-hover results">
                                <thead>
                                <tr>
                                    <th class="col-sm-1">no.</th>
                                    <th class="col-sm-4">이름</th>
                                    <th class="col-sm-2">분야</th>
                                    <th class="col-sm-2">취득일시</th>
                                    <th class="col-sm-offset-1 col-sm-1">선택</th>
                                </tr>
                                </thead>
                                <tbody id="certificateList">
                                <tr>
                                    <td>1</td>
                                    <td class="dropdown">전문 잠자기 자격증</td>
                                    <td>수면</td>
                                    <td class="dropdown"> 1996/04/27</td>
                                    <td><input type="checkbox"></td>
                                </tr>
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
                <form id="certificateAddForm">
                    <div class="col-lg-4">
                        <input type="text" name="name" class="form-control input-sm" id="certificateName" placeholder="제목">
                    </div>
                    <div class="col-lg-2">
                        <input type="text" name="field" class="form-control input-sm" id="certificateField" placeholder="분야">
                    </div>
                    <div class="col-lg-4">
                        <input type="date" name="acquisitionDate" class="form-control input-sm" id="certificateDate">
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-primary btn-sm" id="certificateAddBtn">추가</button>
                    </div>
                </form>
            </div>
            <div class="main-area col-sm-offset-1 col-md-6">
                <h3>수상경력</h3>
                <button type="button" class="pull-right" id="awardDeleteBtn">삭제</button>
                <div class="">
                    <div class="table">
                        <form id="awardDeleteForm">
                            <table class="table table-hover results">
                                <thead>
                                <tr>
                                    <th class="col-sm-1">no.</th>
                                    <th class="col-sm-3">제목</th>
                                    <th class="col-sm-2">분야</th>
                                    <th class="col-sm-2">규모</th>
                                    <th class="col-sm-2">수상일시</th>
                                    <th class="col-sm-offset-1 col-sm-1">선택</th>
                                </tr>
                                </thead>
                                <tbody id="awardList">
                                <tr>
                                    <td>1</td>
                                    <td class="dropdown">잠자기 대회</td>
                                    <td>수면</td>
                                    <td>전국</td>
                                    <td class="dropdown">2020/04/27</td>
                                    <td><input type="checkbox"></td>
                                </tr>
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
                <form id="awardAddForm">
                    <div class="col-lg-4">
                        <input type="text" name="title" class="form-control input-sm" id="awardTitle" placeholder="제목">
                    </div>
                    <div class="col-lg-2">
                        <input type="text" name="field" class="form-control input-sm" id="awardField" placeholder="분야">
                    </div>
                    <div class="col-lg-2">
                        <select name="scale" id="awardScale">
                            <option value="LOCAL">지역</option>
                            <option value="NATIONAL">전국</option>
                            <option value="INTERNATIONAL">국제</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <input type="date" name="acquisitionDate" class="form-control input-sm" id="awardDate">
                    </div>
                    <div class="col-sm-2">
                        <button type="button" class="btn btn-primary btn-sm" id="awardAddBtn">추가</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="js/myLibrary.js"></script>
<script>
	const completedProjectList = $('#completedProjectList');
	const certificateList = $('#certificateList');
	const awardList = $('#awardList');
	const certificateAddBtn = $('#certificateAddBtn');
	const certificateDeleteBtn = $('#certificateDeleteBtn');
	const awardAddBtn = $('#awardAddBtn');
	const awardDeleteBtn = $('#awardDeleteBtn');

	async function init() {
		completedProjectList.empty();
		certificateList.empty();
		awardList.empty();

		try {
			await $.get(getAjaxObject('./api/user/'));
			const projectObjs = await $.get(getAjaxObject(`./api/project/list/complete`));
			const certificates = await $.get(getAjaxObject(`./api/certificate/list`));
			const awards = await $.get(getAjaxObject(`./api/award/list`));

			// 프로젝트 목록
			projectObjs.map((projectObj) => {
				const presentNumbers = {}, allNumbers = {};
				const [presentNumber, allNumber] = getMemberNumbers(projectObj, presentNumbers, allNumbers, 0);
				let item = `<tr><td></td><td class="dropdown">` +
					`<a href="./project.html?no=${projectObj.project.no}&check=y&complete=y">${projectObj.project.title}</a>` +
					'<a class="dropdown-toggle pull-right" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></a>' +
					`<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">${projectObj.project.content}</div></td>` +
					`<td>${new Date(projectObj.project.completedTime).format('yyyy-MM-dd')}</td><td>${projectObj.project.organizer.nickname}</td>` +
					`<td class="dropdown">${presentNumber} / ${allNumber}` +
					'<span class="pull-right">▽</span>' +
					'<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">';

				for (let field in allNumbers) {
					item += `${field} ${presentNumbers[field]} / ${allNumbers[field]}<br>`;
				}

				item = `${item.substr(0, item.length - 4)}</div></td>` +
					`<td><a href="/api/portfolio/download/${projectObj.project.no}" class="pull-left">다운로드</a></td></tr>`;

				completedProjectList.append(item);
			});

			updateIndex(completedProjectList);

			// 자격증 목록
			certificates.map((certificate) => {
				const item = `<tr><input type="hidden" value="${certificate.no}"><td></td>` +
					`<td class="dropdown">${certificate.name}</td><td>${certificate.field}</td>` +
					`<td class="dropdown">${new Date(certificate.acquisitionDate).format('yyyy-MM-dd')}</td>` +
					`<td><input type="checkbox"></td></tr>`;

				certificateList.append(item);
			});

			updateIndex(certificateList);

			// 상장 목록
			const scale = { 'LOCAL': '지역', 'NATIONAL': '전국', 'INTERNATIONAL': '국제' };
			awards.map((award) => {
				let item = `<tr><input type="hidden" value="${award.no}"><td></td>` +
					`<td class="dropdown">${award.title}</td><td>${award.field}</td><td>${scale[award.scale]}</td>` +
					`<td class="dropdown">${new Date(award.acquisitionDate).format('yyyy-MM-dd')}</td>` +
					`<td><input type="checkbox"></td></tr>`;

				awardList.append(item);
			});

			updateIndex(awardList);
		}
		catch (e) {
			alert('세션이 만료되었습니다.');
			window.location = './signIn.html';
		}

		certificateAddBtn.on('click', (e) => {
			e.preventDefault();

			if (!$('#certificateName').val()) {
				alert('자격증 이름을 적어주세요.');
			}
			else if (!$('#certificateField').val()) {
				alert('자격증 분야를 적어주세요.');
			}
			else if (!$('#certificateDate').val()) {
				alert('자격증 취득 날짜를 적어주세요.');
			}
			else {
				insertCertificate();
			}
		});

		certificateDeleteBtn.on('click', (e) => {
			e.preventDefault();

			const deletedList = [];
			certificateList.find('input[type=checkbox]:checked').each((index, item) => {
				const root = $(item).parent().parent();
				root.children().eq(0).attr('name', `CertificateList[${index}].no`);

				deletedList.push(root);
			});

			deleteCertificate(deletedList);
		});

		awardAddBtn.on('click', (e) => {
			e.preventDefault();

			if (!$('#awardTitle').val()) {
				alert('상장 이름을 적어주세요.');
			}
			else if (!$('#awardField').val()) {
				alert('상장 분야를 적어주세요.');
			}
			else if (!$('#awardDate').val()) {
				alert('상장 취득 날짜를 적어주세요.');
			}
			else {
				insertAward();
			}
		});

		awardDeleteBtn.on('click', (e) => {
			e.preventDefault();

			const deletedList = [];
			awardList.find('input[type=checkbox]:checked').each((index, item) => {
				const root = $(item).parent().parent();
				root.children().eq(0).attr('name', `AwardList[${index}].no`);

				deletedList.push(root);
			});

			deleteAward(deletedList);
		});
	}

	async function insertCertificate() {
		try {
			const insertedCertificate = await $.post(getAjaxObject(`./api/certificate/insert`, $('#certificateAddForm').serializeArray()));

			let item = `<tr><input type="hidden" value="${insertedCertificate.no}"><td></td>` +
				`<td class="dropdown">${insertedCertificate.name}</td><td>${insertedCertificate.field}</td>` +
				`<td class="dropdown">${new Date(insertedCertificate.acquisitionDate).format('yyyy-MM-dd')}</td>` +
				`<td><input type="checkbox"></td></tr>`;

			certificateList.append(item);
			updateIndex(certificateList);
		}
		catch (e) {
			alert('추가에 실패하였습니다.');
		}
	}

	async function deleteCertificate(deletedList) {
		try {
			if (await $.delete(getAjaxObject(`./api/certificate/delete`, $('#certificateDeleteForm').serializeArray()))) {
				while (deletedList.length > 0) {
					deletedList.pop().remove();
				}

				updateIndex(certificateList);
			}
		}
		catch (e) {
			alert('삭제에 실패하였습니다.');
		}
	}

	async function insertAward() {
		try {
			const insertedAward = await $.post(getAjaxObject(`./api/award/insert`, $('#awardAddForm').serializeArray()));
			const scale = { 'LOCAL': '지역', 'NATIONAL': '전국', 'INTERNATIONAL': '국제' };
			let item = `<tr><input type="hidden" value="${insertedAward.no}"><td></td>` +
				`<td class="dropdown">${insertedAward.title}</td><td>${insertedAward.field}</td>` +
				`<td>${scale[insertedAward.scale]}</td>` +
				`<td class="dropdown">${new Date(award.acquisitionDate).format('yyyy-MM-dd')}</td>` +
				`<td><input type="checkbox"></td></tr>`;

			awardList.append(item);
			updateIndex(awardList);
		}
		catch (e) {
			alert('추가에 실패하였습니다.');
		}
	}

	async function deleteAward(deletedList) {
		try {
			if (await $.delete(getAjaxObject(`./api/award/delete`, $('#awardDeleteForm').serializeArray()))) {
				while (deletedList.length > 0) {
					deletedList.pop().remove();
				}

				updateIndex(awardList);
			}
		}
		catch (e) {
			alert('삭제에 실패하였습니다.');
		}
	}

	function updateIndex(list) {
		list.children('tr').each((index, item) => {
			$(item).children('td').eq(0).text(index + 1);
		});
	}

	init();
</script>
</body>
</html>
