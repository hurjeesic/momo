<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <title>채팅방</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <style type="text/css">
        table {
            width: 100%;
            border: 1px solid #444444;
        }

        .jumbotron {
            background-image: url('images/bonobono.jpg');
            background-size: cover;
            text-shadow: black 0.2em 0.2em 0.2em;
            color: white;
        }

        .dropdown:hover > .dropdown-menu {
            display: block;
        }

        .list-group-item {
            cursor: pointer;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#bs-example-navber-collapse-1"
                    aria-expanded="false">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="./index.html">모여모여게시판</a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a href="">포트폴리오 <span class="sr-only"></span></a></li>
                <li class="active"><a href="">게시판 <span class="sr-only"></span></a></li>
            </ul>

            <ul class="nav navbar-nav pull-right">
                <li class="active"><a href="./mypage.html">마이페이지<span class="sr-only"></span></a></li>
            </ul>

        </div>
    </div>
</nav>
<div class="container">
    <div class="jumbotron">
        <h1 class="text-center">모모게시판</h1>
        <p class="text-center"> 프로젝트의 거대한 도우미</p>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-2">
            <div class="">
                <div class="row">
                    <div class="col-12">
                        <h1>대화방</h1>
                        <ul class="list-group" id="chatRoomList">
                            <li class="list-group-item">전체 채팅</li>
                            <li class="list-group-item">개발부서</li>
                            <li class="list-group-item">디자인 부서</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-offset-1 col-sm-7">
            <h1>&nbsp;</h1>
            <div class="table" style="width:100%; height:200px; overflow:auto">
                <table class="table results" width="100%" border="0" cellspacing="0" cellpadding="0">
                    <thead>
                    <tr>
                        <th class="col-md-2">이름</th>
                        <th class="col-md-9">내용</th>
                    </tr>
                    </thead>
                    <tbody id="messageList">
                    <tr>
                        <td>고재우</td>
                        <td>우리 프로젝트의 미래는 어떻게 될까??</td>
                    </tr>
                    <tr>
                        <td>허지식</td>
                        <td>수련이 부족해서 그렇다</td>
                    </tr>
                    </tbody>
                </table>
                <input type="text" id="messageTxt">
                <button type="button" id="sendBtn">입력</button>
            </div>
        </div>
        <div class="col-sm-2">
            <h1>참여인원</h1>
            <ul class="list-group" id="chatUserList"></ul>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="js/myLibrary.js"></script>

<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3/stomp.min.js"></script>
<script>
	// websocket & stomp initialize
	let sock = new SockJS('/ws-stomp');
	let ws = Stomp.over(sock);
	let reconnect = 0;

	const projectId = sessionStorage.getItem('project.id');
	let roomId = sessionStorage.getItem('chat.room.id');
	const chatRoomList = $('#chatRoomList');
	const messageTxt = $('#messageTxt');
	const messageList = $('#messageList');
	const chatUserList = $('#chatUserList');
	const title = $('#title');
	const sendBtn = $('#sendBtn');
	let username, memberNo;

	$.ajax({
		type: 'get',
		url: './api/user/',
		dataType: 'json',
		async: false,
		success: (data) => {
			// 받은 유저 정보를 출력
			username = data.nickname;
		},
		error: () => {
			alert('세션이 만료되었습니다.');
			window.location = './signIn.html';
		}
	});

	$.ajax({
		type: 'get',
		url: `./api/member/list/${ projectId }`,
		dataType: 'json',
		async: false,
		success: (members) => {
			chatUserList.empty();
			members.forEach((member) => {
				let item = `<li class="list-group-item">${ member.user.nickname }`;
				if (username == member.user.nickname) {
					memberNo = member.no;
					if (member.user.nickname == member.project.organizer.nickname) {
						item += `<button type="button" class="pull-right" id="completeBtn">완료</button>`;
						chatUserList.append(item);
						$('#completeBtn').on('click', (e) => {
							e.preventDefault();
							$.ajax({
								type: 'get',
								url: `./api/project/complete/${ projectId }`,
								dataType: 'json',
								async: false,
								success: (data) => {
									if (data) {
										alert('프로젝트가 완료되었습니다. 마이페이지에서 후기를 남겨주세요.');
										window.location = './mypage.html';
									}
									else {
										alert('프로젝트 완료 권한이 없습니다.');
									}
								},
								error: () => {
									alert('서버에 오류가 발생하였습니다.');
								}
							});
						});
					}
					else {
						item += `<input type="checkbox" class="pull-right" id="completeBox" value="1" ${ member.complete ? 'checked' : '' }></li>`;
						chatUserList.append(item);
						$('#completeBox').on('click', (e) => {
							console.log("change!");
							const bComplete = $('#completeBox').is(':checked');
							sendComplete(bComplete);
						});
					}
				}
				else if (member.user.nickname != member.project.organizer.nickname) {
					item += `<input class="pull-right" type="checkbox" disabled ${ member.complete ? 'checked' : '' }></li>`;
					chatUserList.append(item);
				}
                else {
					chatUserList.append(item);
                }
			});
		},
		error: () => {
			alert('채팅방을 볼 권한이 없습니다.');
			history.back();
		}
	});

	function findRoomList(projectId) {
		$.ajax({
			type: 'get',
			url: '/api/chat/room/list',
			dataType: 'json',
			data: { projectId: projectId },
			success: (response) => {
				let count = 0;
				if (roomId === null) {
					roomId = response[0].id;
				}

				chatRoomList.empty();
				response.map((room) => {
					let className = 'list-group-item';
					if (room.id == roomId) {
						className += ' active'; // 추가할 class name
					}
					chatRoomList.append(`<li class="${ className }" id="room${ count }">${ room.name }</li>`);
					$(`#room${ count }`).click(() => {
						sessionStorage.setItem('chat.room.id', room.id);
						location.reload();
					});
					count++;
				});

				findRoom(roomId);
				findChatting(roomId);
			},
			error: () => {
				alert('존재하지 않는 프로젝트입니다.');
				window.location = './index.html';
			}
		});
	}

	function findRoom(roomId) {
		$.ajax({
			type: 'get',
			url: `/api/chat/room/${ roomId }`,
			dataType: 'json',
			success: (response) => title.text(response.name)
		});
	}

	function findChatting(roomId) {
		$.ajax({
			type: 'get',
			url: `/api/chat/message/list/${ roomId }`,
			dataType: 'json',
			success: (response) => {
				messageList.empty();
				response.map((message) => {
					messageList.append(`<tr><td>${ message.sender.nickname }</td><td>${ message.message }</td></tr>`);
				});
			}
		});
	}

	function sendMessage(messageTxt) {
		ws.send('/pub/chat/message', {}, JSON.stringify({
			type: 'TALK',
			room: { id: roomId },
			message: messageTxt.val()
		}));
		messageTxt.val('');
	}

	function sendComplete(bComplete) {
		const recvObj = {
			type: 'COMPLETE',
			room: { id: roomId }
		};

		if (bComplete) {
			recvObj['message'] = username;
		}

		ws.send('/pub/chat/message', {}, JSON.stringify(recvObj));
	}

	function recvMessage(recv) {
		if (recv.type == 'COMPLETE') {
			console.log(chatUserList);
		}
		else {
			if (recv.type == 'JOIN') {
				// messageList.append(`<tr><td>[알림] ${recv.message}<td></tr>`);
				// 사용자가 접속했을 때 받을 수 있도록 작동
			}
			else {
				messageList.append(`<tr><td>${ recv.sender.nickname }</td><td>${ recv.message }<td></tr>`);
			}
		}
	}

	function connect() {
		// pub/sub event
		ws.connect({}, function (frame) {
			ws.subscribe(`/sub/chat/room/${ roomId }`, function (message) {
				let recv = JSON.parse(message.body);
				recvMessage(recv);
			});

			ws.send('/pub/chat/message', {}, JSON.stringify({
				type: 'JOIN',
				room: { id: roomId }
			}));
		}, function (error) {
			if (reconnect++ <= 5) {
				setTimeout(function () {
					console.log('connection reconnect');
					sock = new SockJS('/ws-stomp');
					ws = Stomp.over(sock);
					connect();
				}, 10 * 1000);
			}
			else {
				alert('연결이 끊겼습니다.');
				window.location = './index.html';
			}
		});
	}

	messageTxt.on('keydown', (e) => {
		if (e.which == 13) {
			e.preventDefault();
			sendMessage(messageTxt);
		}
	});
	sendBtn.on('click', (e) => {
		e.preventDefault();
		sendMessage(messageTxt);
	});

	findRoomList(projectId);
	connect();
</script>
</body>
</html>