<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <title>채팅방</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <style type="text/css">
        table {
            width: 100%;
            border: 1px solid #444444;
        }

        .jumbotron {
            background-image: url('images/bonobono.jpg');
            background-size: cover;
            text-shadow: black 0.2em 0.2em 0.2em;
            color: white;
        }

        .dropdown:hover > .dropdown-menu {
            display: block;
        }

        .list-group-item {
            cursor: pointer;
        }
    </style>
</head>
<body>
<style type="text/css">

</style>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#bs-example-navber-collapse-1"
                    aria-expanded="false">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="">모여모여게시판</a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a href="">포트폴리오<span class="sr-only"></span></a></li>
                <li class="active"><a href="">게시판<span class="sr-only"></span></a></li>
                <li class="active"><a href="">기업진<span class="sr-only"></span></a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <div class="jumbotron">
        <h1 class="text-center">모모게시판</h1>
        <p class="text-center"> 프로젝트의 거대한 도우미</p>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-sm-2">
            <div class="">
                <div class="row">
                    <div class="col-12">
                        <h1>대화방</h1>
                        <ul class="list-group">
                            <li class="list-group-item">전체 채팅</li>
                            <li class="list-group-item">개발부서</li>
                            <li class="list-group-item">디자인 부서</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-offset-1 col-sm-9">
                <h1>&nbsp;</h1>
                <div class="table" style="width:100%; height:200px; overflow:auto">
                    <table class="table results" width="100%" border="0" cellspacing="0" cellpadding="0">
                        <thead>
                        <tr>
                            <th class="col-md-2">이름</th>
                            <th class="col-md-9">내용</th>
                        </tr>
                        </thead>
                        <tbody id="messageList">
                        <tr>
                            <td>고재우</td>
                            <td>우리 프로젝트의 미래는 어떻게 될까??</td>
                        </tr>
                        <tr>
                            <td>현지호</td>
                            <td>그건 아무도 모르겟지</td>
                        </tr>
                        <tr>
                            <td>허지식</td>
                            <td>수련이 부족해서 그렇다</td>
                        </tr>
                        </tbody>
                    </table>
                    <input type="text" id="messageTxt">
                    <button> 입력</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3/stomp.min.js"></script>
<script>
	// websocket & stomp initialize
	let sock = new SockJS('/ws-stomp');
	let ws = Stomp.over(sock);
	let reconnect = 0;

	let senderId = sessionStorage.getItem('user.id');
	let projectId = sessionStorage.getItem('project.id');
	let roomId = sessionStorage.getItem('chat.room.id');
	const chatRoomList = $('#chatRoomList');
	const messageTxt = $('#messageTxt');
	const messageList = $('#messageList');
	const title = $('#title');

	if (senderId === undefined) {
		history.back();
	}

	function findRoomList(projectId) {
		axios.get('/api/chat/room/list', { projectId: projectId }).then(response => {
			let count = 0;
			if (roomId === undefined) {
				roomId = response.data[0].id;
			}

			chatRoomList.empty();
			response.data.map((room) => {
				let className = 'list-group-item';
				if (room.id == roomId) {
					className += ' active'; // 추가할 class name
				}
				chatRoomList.append('<li class="' + className + '" id="room"' + count + '>' + room.name + '</li>');
				$('#room' + count).click(() => {
					sessionStorage.setItem('chat.room.id', room.id);
					location.reload();
				});
				count++;
			});

			findRoom(roomId);
			findChatting(roomId);
		});
	}

	function findRoom(roomId) {
		axios.get('/api/chat/room/' + roomId).then(response => title.text(response.data.name));
	}

	function findChatting(roomId) {
		axios.get('/api/chat/message/list/' + roomId).then(response => {
			messageList.empty();
			response.data.map((message) => {
				messageList.append('<tr><td>' + message.sender.nickname + '</td><td>' + message.message + '</td></tr>');
			});
		});
	}

	function sendMessage(messageTxt) {
		ws.send('/pub/chat/message', {}, JSON.stringify({
			type: 'TALK',
			room: { id: roomId },
			sender: { no: senderId },
			message: messageTxt.val()
		}));
		messageTxt.val('');
	}

	function recvMessage(recv) {
		messageList.append('<tr><td>' + message.sender.nickname + '</td><td>' + message.message + '</td></tr>');
		if (recv.type == 'ENTER') {
			messageList.append('<tr><td>[알림] ' + recv.message + '<td></tr>');
		}
		else {
			messageList.append('<tr><td>' + recv.sender.nickname + '</td><td>' + recv.message + '<td></tr>');
		}
	}

	function connect() {
		// pub/sub event
		ws.connect({}, function (frame) {
			ws.subscribe('/sub/chat/room/' + roomId, function (message) {
				let recv = JSON.parse(message.body);
				recvMessage(recv);
			});

			ws.send('/pub/chat/message', {}, JSON.stringify({
				type: 'ENTER',
				room: { id: roomId },
				sender: { no: sender }
			}));
		}, function (error) {
			if (reconnect++ <= 5) {
				setTimeout(function () {
					console.log('connection reconnect');
					sock = new SockJS('/ws-stomp');
					ws = Stomp.over(sock);
					connect();
				}, 10 * 1000);
			}
		});
	}

	messageTxt.keydown((key) => {
		if (key.keyCode == 13) {
			sendMessage(messageTxt);
		}
	});
	$('#sendBtn').click(() => sendMessage(messageTxt));

	findRoomList(projectId);
	connect();
</script>
</body>
</html>