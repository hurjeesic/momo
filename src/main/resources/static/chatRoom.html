<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width initial-scale=1">
    <title>채팅방</title>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/myStyle.css">
    <style type="text/css">
        table {
            width: 100%;
            border: 1px solid #444444;
        }

        .jumbotron {
            background-image: url('images/bonobono.jpg');
            background-size: cover;
            text-shadow: black 0.2em 0.2em 0.2em;
            color: white;
        }

        .dropdown:hover > .dropdown-menu {
            display: block;
        }

        .list-group-item {
            cursor: pointer;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target="#bs-example-navber-collapse-1"
                    aria-expanded="false">
                <span class="sr-only"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand">모여모여게시판</a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active" id="portfolioBtn"><a>포트폴리오<span class="sr-only"></span></a></li>
                <li class="active" id="boardBtn"><a>게시판<span class="sr-only"></span></a></li>
            </ul>
            <ul class="nav navbar-nav pull-right">
                <li class="active" id="logoutBtn"><a>로그아웃<span class="sr-only"></span></a></li>
                <li class="active" id="myPageBtn"><a>마이페이지<span class="sr-only"></span></a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <div class="jumbotron">
        <h1 class="text-center">모모게시판</h1>
        <p class="text-center"> 프로젝트의 거대한 도우미</p>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-sm-2">
            <div class="">
                <div class="row">
                    <div class="col-12">
                        <h1>대화방</h1>
                        <ul class="list-group" id="chatRoomList">
                            <li class="list-group-item">전체 채팅</li>
                            <li class="list-group-item">개발부서</li>
                            <li class="list-group-item">디자인 부서</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-offset-1 col-sm-7">
            <h1>&nbsp;</h1>
            <div class="table" style="width:100%; height:200px; overflow:auto">
                <table class="table results" width="100%" border="0" cellspacing="0" cellpadding="0">
                    <thead>
                    <tr>
                        <th class="col-md-2">이름</th>
                        <th class="col-md-9">내용</th>
                    </tr>
                    </thead>
                    <tbody id="messageList">
                    <tr>
                        <td>고재우</td>
                        <td>우리 프로젝트의 미래는 어떻게 될까??</td>
                    </tr>
                    <tr>
                        <td>허지식</td>
                        <td>수련이 부족해서 그렇다</td>
                    </tr>

                    </tbody>
                </table>
            </div>
            <input type="text" id="messageTxt">
            <button type="button" id="sendBtn">입력</button>
        </div>
        <div class="col-sm-2">
            <h1>참여인원</h1>
            <ul class="list-group" id="chatUserList"></ul>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="js/myLibrary.js"></script>

<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3/stomp.min.js"></script>
<script>
	// websocket & stomp initialize
	let sock = new SockJS('/ws-stomp');
	let ws = Stomp.over(sock);
	let reconnect = 0;

	const projectId = sessionStorage.getItem('project.id');
	let roomId = sessionStorage.getItem('chat.room.id');
	const chatRoomList = $('#chatRoomList');
	const messageTxt = $('#messageTxt');
	const messageList = $('#messageList');
	const chatUserList = $('#chatUserList');
	const title = $('#title');
	const sendBtn = $('#sendBtn');
	let username, complete;

	async function init() {
		let errorCode = 0;

		chatUserList.empty();
		chatRoomList.empty();
		messageList.empty();

		try {
			const user = await $.get(getAjaxObject('./api/user/'));
			const projectObj = await $.get(getAjaxObject(`./api/project/${projectId}`));
			errorCode++;
			const members = await $.get(getAjaxObject(`./api/member/list/${projectId}`));
			errorCode++;
			const roomList = await $.get(getAjaxObject('/api/chat/room/list', { projectId: projectId }));
			roomId = roomId == null ? roomList[0].id : roomId;
			const room = await $.get(getAjaxObject(`/api/chat/room/${roomId}`));
			const messages = await $.get(getAjaxObject(`/api/chat/message/list/${roomId}`));

			// 사용자 정보
			username = user.nickname;

			// 프로젝트 정보
			complete = projectObj.project.complete;

			// 프로젝트 맴버 정보
			members.forEach((member) => {
				let item = `<li class="list-group-item">${member.user.nickname}`;
				const memberName = member.user.nickname;
				if (!complete && username == memberName) {
					if (memberName == member.project.organizer.nickname) {
						item += `<button type="button" class="pull-right" id="completeBtn">완료</button>`;
						chatUserList.append(item);
						$('#completeBtn').on('click', (e) => grantCompleteEvent(e));
					}
					else {
						item += `<input type="checkbox" class="pull-right" id="completeBox" value="1" ${member.complete ? 'checked' : ''}></li>`;
						chatUserList.append(item);
						$('#completeBox').on('click', (e) => sendComplete($('#completeBox').is(':checked')));
					}
				}
				else {
					if (complete || memberName != member.project.organizer.nickname) {
						item += `<input class="pull-right" type="checkbox" disabled ${member.complete ? 'checked' : ''}></li>`;
					}
					else {
						item += '</li>';
					}

					chatUserList.append(item);
				}
			});

			// 프로젝트 방 번호 목록
			let count = 0;
			roomList.map((room) => {
				let className = 'list-group-item';
				if (room.id == roomId) {
					className += ' active'; // 추가할 class name
				}

				chatRoomList.append(`<li class="${className}" id="room${count}">${room.name}</li>`);
				$(`#room${count}`).click(() => {
					sessionStorage.setItem('chat.room.id', room.id);
					location.reload();
				});
				count++;
			});

			// 접속한 방 이름
			title.text(room.name);

			// 접속한 방의 메시지 목록
			messages.map((message) => messageList.append(`<tr><td>${message.sender.nickname}</td><td>${message.message}</td></tr>`));
		}
		catch (e) {
			switch (errorCode) {
				case 0:
					alert('세션이 만료되었습니다.');
					window.location = './signIn.html';
					break;
				case 1:
					alert('채팅방을 볼 권한이 없습니다.');
					history.back();
					break;
				case 2:
					alert('존재하지 않는 프로젝트입니다.');
					window.location = './index.html';
					break;
			}
		}

		messageTxt.on('keydown', (e) => {
			if (e.which == 13) {
				e.preventDefault();

				sendMessage(messageTxt);
			}
		});

		sendBtn.on('click', (e) => sendMessage(messageTxt));
	}

	async function grantCompleteEvent(e) {
		e.preventDefault();

		try {
			const result = await $.post(getAjaxObject(`./api/project/complete/${projectId}`));
			if (result) {
				alert('프로젝트가 완료되었습니다. 마이페이지에서 후기를 남겨주세요.');
				window.location = './mypage.html';
			}
			else {
				alert('프로젝트 완료 권한이 없습니다.');
			}
		}
		catch (e) {
			alert('서버에 오류가 발생하였습니다.');
		}
	}

	function sendMessage(messageTxt) {
		ws.send('/pub/chat/message', {}, JSON.stringify({
			type: 'TALK',
			room: { id: roomId },
			message: messageTxt.val()
		}));
		messageTxt.val('');
	}

	function sendComplete(bComplete) {
		const recvObj = {
			type: 'COMPLETE',
			room: { id: roomId }
		};

		if (bComplete) {
			recvObj['message'] = username;
		}

		ws.send('/pub/chat/message', {}, JSON.stringify(recvObj));
	}

	function recvMessage(recv) {
		if (recv.type == 'COMPLETE') {
			for (const item of chatUserList.contents()) {
				if (item.firstChild.textContent == recv.sender.nickname && username != recv.sender.nickname) {
					item.lastChild.checked = !item.lastChild.checked;
				}
			}
		}
		else {
			if (recv.type == 'JOIN') {
				// messageList.append(`<tr><td>[알림] ${recv.message}<td></tr>`);
				// 사용자가 접속했을 때 받을 수 있도록 작동
				console.log('대화 준비 완료');
			}
			else {
				messageList.append(`<tr><td>${recv.sender.nickname}</td><td>${recv.message}<td></tr>`);
			}
		}
	}

	function connect() {
		// pub/sub event
		ws.connect({}, (frame) => {
			ws.subscribe(`/sub/chat/room/${roomId}`, (message) => {
				let recv = JSON.parse(message.body);
				recvMessage(recv);
			});

			ws.send('/pub/chat/message', {}, JSON.stringify({
				type: 'JOIN',
				room: { id: roomId }
			}));
		}, function (error) {
			if (reconnect++ <= 5) {
				setTimeout(() => {
					console.log('connection reconnect');
					sock = new SockJS('/ws-stomp');
					ws = Stomp.over(sock);
					connect();
				}, 10 * 1000);
			}
			else {
				alert('연결이 끊겼습니다.');
				window.location = './index.html';
			}
		});
	}

	init();
	connect();
</script>
</body>
</html>